# 음성 AI 건강주치의 앱 - 프로젝트 설정 가이드

**Version:** 1.0  
**작성일:** 2025년 12월  
**관련 문서:** PRD v1.0, TRD v1.0, AI 캐릭터 시스템 프롬프트 가이드 v1.0

---

## 목차

1. [개발 환경 설정](#1-개발-환경-설정)
2. [Flutter 프로젝트 구조](#2-flutter-프로젝트-구조)
3. [Backend 프로젝트 구조](#3-backend-프로젝트-구조)
4. [Docker 설정](#4-docker-설정)
5. [환경 변수 설정](#5-환경-변수-설정)
6. [코드 템플릿](#6-코드-템플릿)
7. [개발 워크플로우](#7-개발-워크플로우)
8. [배포 가이드](#8-배포-가이드)

---

## 1. 개발 환경 설정

### 1.1 필수 소프트웨어

```bash
# 시스템 요구사항
- OS: macOS 12+ / Windows 10+ / Ubuntu 20.04+
- RAM: 8GB 이상 (16GB 권장)
- Disk: 20GB 이상 여유 공간
- CPU: Intel i5 / Apple M1 이상

# 필수 설치 목록
1. Flutter SDK 3.16+
2. Dart SDK 3.2+ (Flutter에 포함)
3. Android Studio 2023+ (Android 개발)
4. Xcode 15+ (iOS 개발, macOS only)
5. VS Code (권장 에디터)
6. Docker Desktop
7. Python 3.11+
8. Git
```

### 1.2 Flutter 설치

```bash
# macOS (Homebrew)
brew install --cask flutter

# 또는 공식 사이트에서 다운로드
# https://docs.flutter.dev/get-started/install

# 설치 확인
flutter doctor

# 예상 출력:
# [✓] Flutter (Channel stable, 3.16.x)
# [✓] Android toolchain
# [✓] Xcode
# [✓] Chrome
# [✓] Android Studio
# [✓] VS Code
```

### 1.3 Python 환경 설정

```bash
# pyenv 설치 (권장)
# macOS
brew install pyenv

# pyenv로 Python 설치
pyenv install 3.11.7
pyenv global 3.11.7

# 확인
python --version  # Python 3.11.7
```

### 1.4 VS Code 확장 설치

```json
// 권장 확장 목록 (.vscode/extensions.json)
{
  "recommendations": [
    // Flutter/Dart
    "Dart-Code.dart-code",
    "Dart-Code.flutter",
    
    // Python
    "ms-python.python",
    "ms-python.vscode-pylance",
    
    // Docker
    "ms-azuretools.vscode-docker",
    
    // Git
    "eamodio.gitlens",
    
    // API 테스트
    "rangav.vscode-thunder-client",
    
    // 기타
    "esbenp.prettier-vscode",
    "streetsidesoftware.code-spell-checker",
    "usernamehw.errorlens"
  ]
}
```

### 1.5 Git 설정

```bash
# 기본 설정
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 유용한 alias
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.st status
git config --global alias.lg "log --oneline --graph --all"
```

---

## 2. Flutter 프로젝트 구조

### 2.1 프로젝트 생성

```bash
# 프로젝트 생성
flutter create --org com.healthai health_ai_app
cd health_ai_app

# 플랫폼별 설정
flutter config --enable-android
flutter config --enable-ios
```

### 2.2 디렉토리 구조

```
health_ai_app/
├── lib/
│   ├── main.dart                    # 앱 진입점
│   ├── app/
│   │   ├── app.dart                 # MaterialApp 설정
│   │   ├── routes.dart              # 라우팅 설정
│   │   └── themes.dart              # 테마 설정
│   │
│   ├── core/                        # 핵심 유틸리티
│   │   ├── config/
│   │   │   ├── app_config.dart      # 앱 설정
│   │   │   └── api_config.dart      # API 설정
│   │   ├── constants/
│   │   │   ├── app_constants.dart   # 앱 상수
│   │   │   ├── api_endpoints.dart   # API 엔드포인트
│   │   │   └── asset_paths.dart     # 에셋 경로
│   │   ├── errors/
│   │   │   ├── exceptions.dart      # 커스텀 예외
│   │   │   └── failures.dart        # 실패 타입
│   │   ├── network/
│   │   │   ├── api_client.dart      # Dio 클라이언트
│   │   │   ├── api_interceptors.dart # 인터셉터
│   │   │   └── network_info.dart    # 네트워크 상태
│   │   ├── storage/
│   │   │   ├── secure_storage.dart  # 보안 저장소
│   │   │   └── local_storage.dart   # 로컬 캐시
│   │   └── utils/
│   │       ├── extensions.dart      # 확장 함수
│   │       ├── validators.dart      # 유효성 검증
│   │       └── helpers.dart         # 헬퍼 함수
│   │
│   ├── features/                    # 기능별 모듈
│   │   ├── auth/                    # 인증
│   │   │   ├── data/
│   │   │   │   ├── datasources/
│   │   │   │   ├── models/
│   │   │   │   └── repositories/
│   │   │   ├── domain/
│   │   │   │   ├── entities/
│   │   │   │   ├── repositories/
│   │   │   │   └── usecases/
│   │   │   └── presentation/
│   │   │       ├── pages/
│   │   │       ├── widgets/
│   │   │       └── providers/
│   │   │
│   │   ├── consultation/            # 음성 상담
│   │   │   ├── data/
│   │   │   ├── domain/
│   │   │   └── presentation/
│   │   │
│   │   ├── family/                  # 가족 프로필
│   │   │   ├── data/
│   │   │   ├── domain/
│   │   │   └── presentation/
│   │   │
│   │   ├── health/                  # 건강 데이터
│   │   │   ├── data/
│   │   │   ├── domain/
│   │   │   └── presentation/
│   │   │
│   │   ├── products/                # 제품 추천
│   │   │   ├── data/
│   │   │   ├── domain/
│   │   │   └── presentation/
│   │   │
│   │   ├── routine/                 # 루틴/감사일기
│   │   │   ├── data/
│   │   │   ├── domain/
│   │   │   └── presentation/
│   │   │
│   │   └── settings/                # 설정
│   │       ├── data/
│   │       ├── domain/
│   │       └── presentation/
│   │
│   └── shared/                      # 공유 컴포넌트
│       ├── widgets/
│       │   ├── buttons/
│       │   ├── inputs/
│       │   ├── cards/
│       │   ├── dialogs/
│       │   └── loading/
│       └── providers/
│           └── app_providers.dart
│
├── test/                            # 테스트
│   ├── unit/
│   ├── widget/
│   └── integration/
│
├── assets/                          # 에셋
│   ├── images/
│   ├── icons/
│   ├── fonts/
│   └── animations/
│
├── android/                         # Android 네이티브
├── ios/                             # iOS 네이티브
│
├── pubspec.yaml                     # 의존성
├── analysis_options.yaml            # Lint 설정
└── README.md
```

### 2.3 pubspec.yaml

```yaml
name: health_ai_app
description: 음성 AI 건강주치의 앱
publish_to: 'none'

version: 1.0.0+1

environment:
  sdk: '>=3.2.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter

  # 상태관리
  flutter_riverpod: ^2.4.9
  riverpod_annotation: ^2.3.3

  # 라우팅
  go_router: ^13.0.0

  # 네트워크
  dio: ^5.4.0
  web_socket_channel: ^2.4.0
  connectivity_plus: ^5.0.2

  # 오디오
  flutter_sound: ^9.2.13
  permission_handler: ^11.2.0
  audio_waveforms: ^1.0.5

  # 헬스데이터
  health: ^8.1.0

  # 로컬 저장소
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  shared_preferences: ^2.2.2
  flutter_secure_storage: ^9.0.0

  # Firebase
  firebase_core: ^2.24.2
  firebase_auth: ^4.16.0
  firebase_messaging: ^14.7.10
  firebase_analytics: ^10.8.0

  # 결제
  in_app_purchase: ^3.1.13

  # 광고
  google_mobile_ads: ^4.0.0

  # UI 컴포넌트
  flutter_svg: ^2.0.9
  cached_network_image: ^3.3.1
  shimmer: ^3.0.0
  fl_chart: ^0.66.0
  lottie: ^3.0.0

  # 유틸리티
  intl: ^0.18.1
  uuid: ^4.3.1
  logger: ^2.0.2+1
  equatable: ^2.0.5
  dartz: ^0.10.1
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1

  # 아이콘
  cupertino_icons: ^1.0.6

dev_dependencies:
  flutter_test:
    sdk: flutter

  # Lint
  flutter_lints: ^3.0.1

  # 코드 생성
  riverpod_generator: ^2.3.9
  build_runner: ^2.4.8
  hive_generator: ^2.0.1
  freezed: ^2.4.6
  json_serializable: ^6.7.1

  # 테스트
  mockito: ^5.4.4
  mocktail: ^1.0.2

flutter:
  uses-material-design: true

  assets:
    - assets/images/
    - assets/icons/
    - assets/animations/

  fonts:
    - family: Pretendard
      fonts:
        - asset: assets/fonts/Pretendard-Regular.otf
        - asset: assets/fonts/Pretendard-Medium.otf
          weight: 500
        - asset: assets/fonts/Pretendard-SemiBold.otf
          weight: 600
        - asset: assets/fonts/Pretendard-Bold.otf
          weight: 700
```

### 2.4 analysis_options.yaml

```yaml
include: package:flutter_lints/flutter.yaml

analyzer:
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"
  errors:
    invalid_annotation_target: ignore

linter:
  rules:
    # 에러 방지
    avoid_print: true
    avoid_empty_else: true
    avoid_returning_null_for_future: true
    cancel_subscriptions: true
    close_sinks: true

    # 스타일
    prefer_const_constructors: true
    prefer_const_declarations: true
    prefer_final_fields: true
    prefer_final_locals: true
    sort_constructors_first: true
    sort_unnamed_constructors_first: true

    # 문서화
    public_member_api_docs: false

    # 기타
    always_declare_return_types: true
    annotate_overrides: true
    avoid_function_literals_in_foreach_calls: true
```

---

## 3. Backend 프로젝트 구조

### 3.1 디렉토리 구조

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                      # FastAPI 앱 진입점
│   │
│   ├── core/                        # 핵심 설정
│   │   ├── __init__.py
│   │   ├── config.py                # 환경 설정
│   │   ├── security.py              # 보안 (JWT, 암호화)
│   │   ├── database.py              # DB 연결
│   │   └── dependencies.py          # 의존성 주입
│   │
│   ├── models/                      # SQLAlchemy 모델
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── family.py
│   │   ├── consultation.py
│   │   ├── health.py
│   │   ├── product.py
│   │   └── subscription.py
│   │
│   ├── schemas/                     # Pydantic 스키마
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── family.py
│   │   ├── consultation.py
│   │   ├── health.py
│   │   ├── product.py
│   │   └── common.py
│   │
│   ├── api/                         # API 라우터
│   │   ├── __init__.py
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── router.py            # 메인 라우터
│   │       ├── auth.py
│   │       ├── users.py
│   │       ├── family.py
│   │       ├── consultations.py
│   │       ├── health.py
│   │       ├── products.py
│   │       ├── routines.py
│   │       └── subscriptions.py
│   │
│   ├── services/                    # 비즈니스 로직
│   │   ├── __init__.py
│   │   ├── auth_service.py
│   │   ├── user_service.py
│   │   ├── family_service.py
│   │   ├── consultation_service.py
│   │   ├── health_service.py
│   │   ├── product_service.py
│   │   └── subscription_service.py
│   │
│   ├── repositories/                # 데이터 접근 계층
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── user_repository.py
│   │   ├── family_repository.py
│   │   └── ...
│   │
│   └── utils/                       # 유틸리티
│       ├── __init__.py
│       ├── helpers.py
│       └── validators.py
│
├── ai/                              # AI/ML 모듈
│   ├── __init__.py
│   ├── voice/                       # 음성 처리
│   │   ├── __init__.py
│   │   ├── realtime_client.py       # OpenAI Realtime
│   │   └── session_manager.py
│   │
│   ├── rag/                         # RAG 시스템
│   │   ├── __init__.py
│   │   ├── retriever.py
│   │   ├── generator.py
│   │   └── knowledge_base.py
│   │
│   ├── characters/                  # AI 캐릭터
│   │   ├── __init__.py
│   │   ├── prompts/                 # 시스템 프롬프트
│   │   │   ├── park_jihoon.py
│   │   │   ├── choi_hyunwoo.py
│   │   │   └── ...
│   │   └── character_manager.py
│   │
│   └── safety/                      # 안전 필터
│       ├── __init__.py
│       ├── emergency_detector.py
│       └── content_filter.py
│
├── tests/                           # 테스트
│   ├── __init__.py
│   ├── conftest.py
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── alembic/                         # DB 마이그레이션
│   ├── versions/
│   ├── env.py
│   └── alembic.ini
│
├── scripts/                         # 유틸리티 스크립트
│   ├── seed_data.py
│   ├── scrape_knowledge.py
│   └── build_vectors.py
│
├── requirements.txt
├── requirements-dev.txt
├── Dockerfile
├── docker-compose.yml
├── .env.example
└── README.md
```

### 3.2 requirements.txt

```txt
# Web Framework
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-multipart==0.0.6
python-jose[cryptography]==3.3.0

# Database
sqlalchemy==2.0.25
asyncpg==0.29.0
alembic==1.13.1
redis==5.0.1

# Auth
passlib[bcrypt]==1.7.4
firebase-admin==6.4.0

# AI/ML
openai==1.10.0
langchain==0.1.4
langchain-openai==0.0.5
chromadb==0.4.22
tiktoken==0.5.2

# Web Scraping (Knowledge Base)
trafilatura==1.7.0
beautifulsoup4==4.12.3
httpx==0.26.0

# Validation & Serialization
pydantic==2.6.0
pydantic-settings==2.1.0
email-validator==2.1.0

# Utilities
python-dotenv==1.0.1
aiohttp==3.9.3
tenacity==8.2.3

# Monitoring
sentry-sdk[fastapi]==1.39.2
prometheus-client==0.19.0

# Task Queue
celery==5.3.6
flower==2.0.1
```

### 3.3 requirements-dev.txt

```txt
-r requirements.txt

# Testing
pytest==7.4.4
pytest-asyncio==0.23.3
pytest-cov==4.1.0
httpx==0.26.0

# Code Quality
black==24.1.1
isort==5.13.2
flake8==7.0.0
mypy==1.8.0

# Pre-commit
pre-commit==3.6.0
```

---

## 4. Docker 설정

### 4.1 docker-compose.yml (개발용)

```yaml
version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: healthai_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: healthai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: healthai_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Chroma DB (Vector Database)
  chroma:
    image: chromadb/chroma:latest
    container_name: healthai_chroma
    ports:
      - "8005:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE

  # Backend API
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: healthai_api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/healthai
      - REDIS_URL=redis://redis:6379
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      chroma:
        condition: service_started
    volumes:
      - ./backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  postgres_data:
  redis_data:
  chroma_data:
```

### 4.2 Backend Dockerfile

```dockerfile
# backend/Dockerfile

FROM python:3.11-slim

WORKDIR /app

# 시스템 의존성 설치
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 소스 코드 복사
COPY . .

# 포트 노출
EXPOSE 8000

# 실행
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 4.3 .dockerignore

```
# Git
.git
.gitignore

# Python
__pycache__
*.py[cod]
*$py.class
.Python
*.so
.eggs
*.egg-info
.installed.cfg
*.egg
.mypy_cache
.pytest_cache

# Virtual Environment
venv
.venv
ENV

# IDE
.idea
.vscode
*.swp
*.swo

# Environment
.env
.env.local
*.env

# Test
htmlcov
.coverage
.tox

# Build
dist
build

# Logs
*.log
logs

# macOS
.DS_Store
```

---

## 5. 환경 변수 설정

### 5.1 Flutter (.env)

```bash
# .env (Flutter)

# API
API_BASE_URL=http://localhost:8000/api/v1
WS_BASE_URL=ws://localhost:8000/ws

# Firebase
FIREBASE_API_KEY=your_firebase_api_key
FIREBASE_APP_ID=your_firebase_app_id
FIREBASE_MESSAGING_SENDER_ID=your_sender_id
FIREBASE_PROJECT_ID=your_project_id

# AdMob
ADMOB_APP_ID_ANDROID=ca-app-pub-xxxxxxxxxxxxx~xxxxxxxxxx
ADMOB_APP_ID_IOS=ca-app-pub-xxxxxxxxxxxxx~xxxxxxxxxx
ADMOB_BANNER_ID_ANDROID=ca-app-pub-xxxxxxxxxxxxx/xxxxxxxxxx
ADMOB_BANNER_ID_IOS=ca-app-pub-xxxxxxxxxxxxx/xxxxxxxxxx

# 환경
ENV=development
```

### 5.2 Backend (.env)

```bash
# backend/.env

# App
APP_ENV=development
DEBUG=true
SECRET_KEY=your-super-secret-key-change-in-production

# Database
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/healthai
DATABASE_POOL_SIZE=5
DATABASE_MAX_OVERFLOW=10

# Redis
REDIS_URL=redis://localhost:6379
REDIS_DB=0

# Chroma
CHROMA_HOST=localhost
CHROMA_PORT=8005

# OpenAI
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_MODEL=gpt-4o
OPENAI_EMBEDDING_MODEL=text-embedding-3-small

# Firebase
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxx@your-project.iam.gserviceaccount.com

# JWT
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=7

# Encryption
ENCRYPTION_KEY=your-32-byte-encryption-key

# External APIs
COUPANG_ACCESS_KEY=your-coupang-access-key
COUPANG_SECRET_KEY=your-coupang-secret-key
IHERB_AFFILIATE_ID=your-iherb-id

# Sentry
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx

# CORS
CORS_ORIGINS=http://localhost:3000,capacitor://localhost,http://localhost
```

### 5.3 환경 변수 로드 (Backend)

```python
# backend/app/core/config.py

from pydantic_settings import BaseSettings
from functools import lru_cache
from typing import List

class Settings(BaseSettings):
    # App
    APP_ENV: str = "development"
    DEBUG: bool = True
    SECRET_KEY: str
    
    # Database
    DATABASE_URL: str
    DATABASE_POOL_SIZE: int = 5
    DATABASE_MAX_OVERFLOW: int = 10
    
    # Redis
    REDIS_URL: str
    REDIS_DB: int = 0
    
    # Chroma
    CHROMA_HOST: str = "localhost"
    CHROMA_PORT: int = 8005
    
    # OpenAI
    OPENAI_API_KEY: str
    OPENAI_MODEL: str = "gpt-4o"
    OPENAI_EMBEDDING_MODEL: str = "text-embedding-3-small"
    
    # Firebase
    FIREBASE_PROJECT_ID: str
    FIREBASE_PRIVATE_KEY: str
    FIREBASE_CLIENT_EMAIL: str
    
    # JWT
    JWT_SECRET_KEY: str
    JWT_ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60
    REFRESH_TOKEN_EXPIRE_DAYS: int = 7
    
    # Encryption
    ENCRYPTION_KEY: str
    
    # CORS
    CORS_ORIGINS: str = "http://localhost:3000"
    
    @property
    def cors_origins_list(self) -> List[str]:
        return [origin.strip() for origin in self.CORS_ORIGINS.split(",")]
    
    class Config:
        env_file = ".env"
        case_sensitive = True

@lru_cache()
def get_settings() -> Settings:
    return Settings()

settings = get_settings()
```

---

## 6. 코드 템플릿

### 6.1 Flutter - main.dart

```dart
// lib/main.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:hive_flutter/hive_flutter.dart';

import 'app/app.dart';
import 'core/config/app_config.dart';
import 'firebase_options.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Firebase 초기화
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  // Hive 초기화
  await Hive.initFlutter();
  
  // 앱 설정 로드
  await AppConfig.initialize();
  
  runApp(
    const ProviderScope(
      child: HealthAIApp(),
    ),
  );
}
```

### 6.2 Flutter - App

```dart
// lib/app/app.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'routes.dart';
import 'themes.dart';

class HealthAIApp extends ConsumerWidget {
  const HealthAIApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final router = ref.watch(routerProvider);
    
    return MaterialApp.router(
      title: '건강주치의',
      debugShowCheckedModeBanner: false,
      
      // 테마
      theme: AppThemes.lightTheme,
      darkTheme: AppThemes.darkTheme,
      themeMode: ThemeMode.system,
      
      // 라우팅
      routerConfig: router,
      
      // 로케일
      locale: const Locale('ko', 'KR'),
      supportedLocales: const [
        Locale('ko', 'KR'),
        Locale('en', 'US'),
      ],
    );
  }
}
```

### 6.3 Flutter - Routes

```dart
// lib/app/routes.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../features/auth/presentation/pages/login_page.dart';
import '../features/auth/presentation/pages/register_page.dart';
import '../features/consultation/presentation/pages/consultation_page.dart';
import '../features/consultation/presentation/pages/character_select_page.dart';
import '../features/family/presentation/pages/family_list_page.dart';
import '../features/family/presentation/pages/family_detail_page.dart';
import '../features/health/presentation/pages/health_dashboard_page.dart';
import '../features/routine/presentation/pages/routine_page.dart';
import '../features/settings/presentation/pages/settings_page.dart';
import '../shared/widgets/main_scaffold.dart';

final routerProvider = Provider<GoRouter>((ref) {
  return GoRouter(
    initialLocation: '/login',
    debugLogDiagnostics: true,
    
    routes: [
      // Auth Routes
      GoRoute(
        path: '/login',
        name: 'login',
        builder: (context, state) => const LoginPage(),
      ),
      GoRoute(
        path: '/register',
        name: 'register',
        builder: (context, state) => const RegisterPage(),
      ),
      
      // Main Shell (Bottom Navigation)
      ShellRoute(
        builder: (context, state, child) => MainScaffold(child: child),
        routes: [
          // Home (Health Dashboard)
          GoRoute(
            path: '/',
            name: 'home',
            builder: (context, state) => const HealthDashboardPage(),
          ),
          
          // Consultation
          GoRoute(
            path: '/consultation',
            name: 'consultation',
            builder: (context, state) => const CharacterSelectPage(),
            routes: [
              GoRoute(
                path: ':characterId',
                name: 'consultation-session',
                builder: (context, state) {
                  final characterId = state.pathParameters['characterId']!;
                  return ConsultationPage(characterId: characterId);
                },
              ),
            ],
          ),
          
          // Family
          GoRoute(
            path: '/family',
            name: 'family',
            builder: (context, state) => const FamilyListPage(),
            routes: [
              GoRoute(
                path: ':familyId',
                name: 'family-detail',
                builder: (context, state) {
                  final familyId = state.pathParameters['familyId']!;
                  return FamilyDetailPage(familyId: familyId);
                },
              ),
            ],
          ),
          
          // Routine
          GoRoute(
            path: '/routine',
            name: 'routine',
            builder: (context, state) => const RoutinePage(),
          ),
          
          // Settings
          GoRoute(
            path: '/settings',
            name: 'settings',
            builder: (context, state) => const SettingsPage(),
          ),
        ],
      ),
    ],
    
    // 에러 페이지
    errorBuilder: (context, state) => Scaffold(
      body: Center(
        child: Text('페이지를 찾을 수 없습니다: ${state.uri}'),
      ),
    ),
    
    // 리다이렉트 (인증 체크)
    redirect: (context, state) {
      // TODO: 인증 상태에 따른 리다이렉트 로직
      return null;
    },
  );
});
```

### 6.4 Flutter - Theme

```dart
// lib/app/themes.dart

import 'package:flutter/material.dart';

class AppThemes {
  // 색상
  static const Color primaryColor = Color(0xFF2E7D32);  // 녹색
  static const Color secondaryColor = Color(0xFF1976D2);  // 파랑
  static const Color errorColor = Color(0xFFD32F2F);
  static const Color warningColor = Color(0xFFF57C00);
  
  // Light Theme
  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      
      // 색상 스키마
      colorScheme: ColorScheme.fromSeed(
        seedColor: primaryColor,
        brightness: Brightness.light,
      ),
      
      // 앱바
      appBarTheme: const AppBarTheme(
        centerTitle: true,
        elevation: 0,
        scrolledUnderElevation: 1,
      ),
      
      // 카드
      cardTheme: CardTheme(
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
      ),
      
      // 버튼
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          minimumSize: const Size(double.infinity, 52),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),
      
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: OutlinedButton.styleFrom(
          minimumSize: const Size(double.infinity, 52),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),
      
      // 인풋
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: Colors.grey.shade100,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: primaryColor, width: 2),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: errorColor, width: 2),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
      
      // 폰트
      fontFamily: 'Pretendard',
      textTheme: const TextTheme(
        displayLarge: TextStyle(fontSize: 32, fontWeight: FontWeight.bold),
        displayMedium: TextStyle(fontSize: 28, fontWeight: FontWeight.bold),
        displaySmall: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
        headlineMedium: TextStyle(fontSize: 20, fontWeight: FontWeight.w600),
        titleLarge: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
        titleMedium: TextStyle(fontSize: 16, fontWeight: FontWeight.w500),
        bodyLarge: TextStyle(fontSize: 16),
        bodyMedium: TextStyle(fontSize: 14),
        labelLarge: TextStyle(fontSize: 14, fontWeight: FontWeight.w600),
      ),
    );
  }
  
  // Dark Theme
  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      
      colorScheme: ColorScheme.fromSeed(
        seedColor: primaryColor,
        brightness: Brightness.dark,
      ),
      
      fontFamily: 'Pretendard',
    );
  }
}
```

### 6.5 Backend - main.py

```python
# backend/app/main.py

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
import logging

from app.core.config import settings
from app.core.database import init_db, close_db
from app.api.v1.router import api_router

# 로깅 설정
logging.basicConfig(
    level=logging.DEBUG if settings.DEBUG else logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """앱 시작/종료 시 실행"""
    # Startup
    logger.info("Starting application...")
    await init_db()
    logger.info("Database initialized")
    
    yield
    
    # Shutdown
    logger.info("Shutting down application...")
    await close_db()
    logger.info("Database connection closed")

# FastAPI 앱 생성
app = FastAPI(
    title="Health AI API",
    description="음성 AI 건강주치의 앱 백엔드 API",
    version="1.0.0",
    lifespan=lifespan,
    docs_url="/docs" if settings.DEBUG else None,
    redoc_url="/redoc" if settings.DEBUG else None,
)

# CORS 설정
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins_list,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# API 라우터 등록
app.include_router(api_router, prefix="/api/v1")

# Health Check
@app.get("/health")
async def health_check():
    return {"status": "healthy", "version": "1.0.0"}

# Root
@app.get("/")
async def root():
    return {"message": "Health AI API", "docs": "/docs"}
```

### 6.6 Backend - Database

```python
# backend/app/core/database.py

from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import declarative_base
from typing import AsyncGenerator

from app.core.config import settings

# 엔진 생성
engine = create_async_engine(
    settings.DATABASE_URL,
    pool_size=settings.DATABASE_POOL_SIZE,
    max_overflow=settings.DATABASE_MAX_OVERFLOW,
    echo=settings.DEBUG,
)

# 세션 팩토리
AsyncSessionLocal = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
)

# Base 클래스
Base = declarative_base()

async def init_db():
    """데이터베이스 초기화"""
    async with engine.begin() as conn:
        # 개발 환경에서만 테이블 자동 생성
        if settings.DEBUG:
            await conn.run_sync(Base.metadata.create_all)

async def close_db():
    """데이터베이스 연결 종료"""
    await engine.dispose()

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """DB 세션 의존성"""
    async with AsyncSessionLocal() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
        finally:
            await session.close()
```

### 6.7 Backend - User Model

```python
# backend/app/models/user.py

from sqlalchemy import Column, String, Boolean, DateTime, Enum
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from datetime import datetime
import uuid
import enum

from app.core.database import Base

class SubscriptionTier(str, enum.Enum):
    FREE = "free"
    BASIC = "basic"
    PREMIUM = "premium"
    FAMILY = "family"

class User(Base):
    __tablename__ = "users"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email = Column(String(255), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=True)  # SNS 로그인 시 NULL
    name = Column(String(100), nullable=False)
    phone = Column(String(20), nullable=True)
    
    # SNS 연동
    provider = Column(String(20), nullable=True)  # email, kakao, google, apple
    provider_id = Column(String(255), nullable=True)
    
    # 구독 정보
    subscription_tier = Column(
        Enum(SubscriptionTier),
        default=SubscriptionTier.FREE,
        nullable=False
    )
    subscription_expires_at = Column(DateTime(timezone=True), nullable=True)
    
    # 설정
    notification_enabled = Column(Boolean, default=True)
    language = Column(String(10), default="ko")
    
    # 메타데이터
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow)
    last_login_at = Column(DateTime(timezone=True), nullable=True)
    is_active = Column(Boolean, default=True)
    deleted_at = Column(DateTime(timezone=True), nullable=True)
    
    # Relationships
    family_profiles = relationship("FamilyProfile", back_populates="user", cascade="all, delete-orphan")
    consultations = relationship("Consultation", back_populates="user", cascade="all, delete-orphan")
    subscriptions = relationship("Subscription", back_populates="user", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<User {self.email}>"
```

---

## 7. 개발 워크플로우

### 7.1 Git Branch 전략

```
main (production)
  │
  └── develop (staging)
        │
        ├── feature/auth-login
        ├── feature/consultation-voice
        ├── feature/family-profile
        │
        ├── bugfix/audio-delay
        │
        └── hotfix/critical-bug
```

### 7.2 커밋 메시지 규칙

```bash
# 타입
feat:     새로운 기능
fix:      버그 수정
docs:     문서 수정
style:    코드 포맷팅 (세미콜론 등)
refactor: 리팩토링
test:     테스트 추가
chore:    빌드, 설정 변경

# 예시
feat: 음성 상담 세션 WebSocket 연결 구현
fix: 토큰 만료 시 자동 갱신 오류 수정
docs: API 엔드포인트 문서 추가
refactor: UserRepository 비동기 처리 개선
```

### 7.3 코드 리뷰 체크리스트

```markdown
## PR 리뷰 체크리스트

### 기능
- [ ] 요구사항을 충족하는가?
- [ ] 엣지 케이스를 처리하는가?
- [ ] 에러 처리가 적절한가?

### 코드 품질
- [ ] 코드가 읽기 쉬운가?
- [ ] 중복 코드가 없는가?
- [ ] 함수/클래스가 단일 책임을 가지는가?

### 보안
- [ ] 민감 정보가 노출되지 않는가?
- [ ] 인증/인가가 적절한가?
- [ ] SQL Injection 등 취약점이 없는가?

### 성능
- [ ] 불필요한 API 호출이 없는가?
- [ ] 메모리 누수 가능성이 없는가?
- [ ] N+1 쿼리 문제가 없는가?

### 테스트
- [ ] 단위 테스트가 포함되어 있는가?
- [ ] 테스트 커버리지가 적절한가?
```

### 7.4 Daily Development Flow

```bash
# 1. 최신 코드 받기
git checkout develop
git pull origin develop

# 2. 피처 브랜치 생성
git checkout -b feature/consultation-voice

# 3. 개발 및 커밋
git add .
git commit -m "feat: OpenAI Realtime API 연결 구현"

# 4. 푸시 및 PR 생성
git push origin feature/consultation-voice
# GitHub에서 PR 생성

# 5. 코드 리뷰 후 머지

# 6. 로컬 브랜치 정리
git checkout develop
git pull origin develop
git branch -d feature/consultation-voice
```

---

## 8. 배포 가이드

### 8.1 로컬 개발 환경 실행

```bash
# 1. Docker 서비스 시작
docker-compose up -d postgres redis chroma

# 2. Backend 실행
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env  # 환경 변수 설정
alembic upgrade head  # DB 마이그레이션
uvicorn app.main:app --reload --port 8000

# 3. Flutter 앱 실행 (새 터미널)
cd health_ai_app
flutter pub get
flutter run
```

### 8.2 Render 배포 (초기)

```yaml
# render.yaml

services:
  # Backend API
  - type: web
    name: healthai-api
    env: docker
    dockerfilePath: ./backend/Dockerfile
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: healthai-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: healthai-redis
          type: redis
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
    healthCheckPath: /health
    
databases:
  - name: healthai-db
    plan: starter
    postgresMajorVersion: 15
    
  - name: healthai-redis
    type: redis
    plan: starter
```

### 8.3 앱 스토어 배포

```bash
# Android (Google Play)
# 1. 키스토어 생성
keytool -genkey -v -keystore upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload

# 2. App Bundle 빌드
flutter build appbundle --release

# 3. Google Play Console에서 업로드

# iOS (App Store)
# 1. Apple Developer 인증서 설정
# 2. Archive 빌드
flutter build ios --release

# 3. Xcode에서 Archive → App Store Connect 업로드
```

---

## 부록

### A. 유용한 명령어

```bash
# Flutter
flutter doctor                    # 환경 체크
flutter clean                     # 빌드 캐시 삭제
flutter pub get                   # 의존성 설치
flutter pub upgrade               # 의존성 업그레이드
flutter run -d chrome             # 웹으로 실행
flutter build apk --split-per-abi # ABI별 APK 빌드
flutter test                      # 테스트 실행
flutter analyze                   # 정적 분석

# Backend
alembic revision --autogenerate -m "message"  # 마이그레이션 생성
alembic upgrade head              # 마이그레이션 적용
alembic downgrade -1              # 마이그레이션 롤백
pytest                            # 테스트 실행
pytest --cov=app                  # 커버리지 포함 테스트

# Docker
docker-compose up -d              # 서비스 시작
docker-compose down               # 서비스 중지
docker-compose logs -f api        # 로그 확인
docker-compose exec postgres psql -U postgres  # DB 접속
```

### B. 트러블슈팅

```markdown
## 자주 발생하는 문제

### Flutter

**문제**: `flutter pub get` 실패
**해결**: 
```bash
flutter clean
rm -rf ~/.pub-cache
flutter pub get
```

**문제**: iOS 빌드 실패
**해결**:
```bash
cd ios
rm -rf Pods Podfile.lock
pod install --repo-update
cd ..
flutter build ios
```

### Backend

**문제**: DB 연결 실패
**해결**: 
- Docker 컨테이너 상태 확인: `docker ps`
- 환경 변수 확인: DATABASE_URL

**문제**: Alembic 마이그레이션 충돌
**해결**:
```bash
alembic history
alembic downgrade base
alembic upgrade head
```
```

### C. 버전 히스토리

| 버전 | 일자 | 변경사항 |
|------|------|----------|
| 1.0 | 2025-12 | 최초 작성 |

---

**문서 끝**
